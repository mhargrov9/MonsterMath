# Primal Rift - Educational Gaming Platform

## Overview

Primal Rift is a full-stack educational gaming platform that combines learning with entertainment. Players answer questions in subjects like math and spelling to earn currency, which they can use to purchase and upgrade digital monsters. The application features a modern React frontend with a Node.js/Express backend, utilizing PostgreSQL for data persistence and integrating with Google's Veo API for dynamic monster image generation.

## System Architecture

### Frontend Architecture
- **Framework**: React 18 with TypeScript
- **Routing**: Wouter for client-side routing
- **State Management**: TanStack Query (React Query) for server state management
- **Styling**: Tailwind CSS with custom game-themed colors and animations
- **UI Components**: Radix UI primitives with custom styling via shadcn/ui
- **Build Tool**: Vite for fast development and optimized production builds

### Backend Architecture
- **Runtime**: Node.js with Express.js framework
- **Language**: TypeScript with ES modules
- **Database**: PostgreSQL with Drizzle ORM for type-safe database operations
- **Authentication**: Replit Auth with OpenID Connect integration
- **Session Management**: Express sessions with PostgreSQL storage
- **API Design**: RESTful API endpoints with JSON responses

## Key Components

### Authentication System
- **Provider**: Replit Auth using OpenID Connect
- **Session Storage**: PostgreSQL-backed sessions with connect-pg-simple
- **User Management**: Automatic user creation and profile synchronization
- **Security**: HTTP-only cookies with secure session handling

### Database Schema
- **Users**: Profile data, currency (gold/diamonds), progress tracking
- **Monsters**: Base monster templates with stats and costs
- **User Monsters**: Player-owned monsters with levels and upgrades
- **Questions**: Educational content with difficulty levels and subjects
- **Battles**: PvP battle system with results tracking
- **Sessions**: Secure session storage for authentication

### Game Systems
1. **Learning System**: Question-based gameplay with gold rewards
2. **Monster Lab**: Purchase and upgrade system with visual customization
3. **Battle Arena**: Player vs AI combat with turn-based mechanics
4. **Currency System**: Gold (earned through learning) and Diamonds (premium currency)

### External API Integration
- **Google Veo API**: Dynamic monster image generation based on upgrades
- **Neon Database**: Serverless PostgreSQL hosting
- **Image Caching**: In-memory caching for generated monster images

## Data Flow

1. **User Authentication**: Replit Auth → Session Creation → User Profile Sync
2. **Learning Flow**: Question Fetch → Answer Submission → Reward Calculation → Profile Update
3. **Monster Management**: Purchase Request → Currency Check → Monster Creation → Upgrade Application
4. **Battle System**: Opponent Selection → Battle Simulation → Result Processing → Rewards Distribution
5. **Image Generation**: Monster Data → Veo API Request → Image Cache → Frontend Display

## External Dependencies

### Core Dependencies
- **@neondatabase/serverless**: PostgreSQL database connection
- **drizzle-orm**: Type-safe database ORM
- **express**: Web application framework
- **react**: Frontend UI library
- **@tanstack/react-query**: Server state management
- **passport**: Authentication middleware

### UI/UX Dependencies
- **@radix-ui/***: Accessible UI primitives
- **tailwindcss**: Utility-first CSS framework
- **lucide-react**: Icon library
- **class-variance-authority**: Utility for component variants

### Development Dependencies
- **vite**: Build tool and development server
- **typescript**: Type checking and compilation
- **tsx**: TypeScript execution for server development

## Deployment Strategy

### Development Environment
- **Runtime**: Replit with Node.js 20
- **Database**: Provisioned PostgreSQL instance
- **Port Configuration**: Internal port 5000, external port 80
- **Hot Reload**: Vite HMR for frontend, tsx for backend

### Production Build
- **Frontend**: Vite build with optimized assets
- **Backend**: esbuild compilation to single bundle
- **Deployment Target**: Replit Autoscale
- **Static Assets**: Served from dist/public directory

### Environment Variables
- `DATABASE_URL`: PostgreSQL connection string
- `SESSION_SECRET`: Session encryption key
- `GOOGLE_API_KEY`: Veo API authentication
- `REPL_ID`: Replit environment identifier
- `ISSUER_URL`: OpenID Connect provider URL

## Changelog

- June 13, 2025: Initial setup with photorealistic AI-generated monsters
- June 13, 2025: Migrated to custom monster design system with user-provided images
  - Removed all AI-generated monsters (Fire Dragon, Ice Dragon, Thunder Dragon, Water Dragon, Earth Dragon)
  - Implemented two new monsters from Monster Design Document:
    * Gigalith: Tank/Physical Brawler (HP: 950, MP: 200, Earth-type)
    * Aetherion: Glass Cannon/Psychic Mage (HP: 400, MP: 800, Psychic-type)
  - Enhanced database schema with detailed battle stats (HP, MP, abilities, resistances, weaknesses, level upgrades)
  - Created placeholder graphics system for custom monster images
  - Updated visual generation to support upgrade-specific appearance changes
- June 14, 2025: Enhanced monster card abilities section with professional styling
  - Added contextual icons for each ability type (brain, target, hand, mountain, etc.)
  - Implemented black circles with white "P" for passive abilities
  - Maintained red badges with "A" for active abilities
  - Added bordered containers for each ability to prevent text overflow
  - Increased card heights significantly (medium: 900px) to accommodate all content
  - Fixed abilities section height (360px) with proper spacing and no scroll bars
  - Implemented client-side image caching to eliminate hover lag
  - Added level cap system (max level 10) with both client and server validation
- June 14, 2025: Strategic Battle Engine Development
  - Integrated full Monster Cards into Battle Arena replacing simple image/HP displays
  - Implemented database-driven player attack command interface
  - Created dynamic abilities system reading ACTIVE abilities from monster database
  - Added mana cost validation and deduction system (abilities show "Name (40 MP)" format)
  - Buttons disable automatically when insufficient MP available
  - Added strategic decision-making with complete stat visibility during battles
  - Level 10 Gigalith set as default opponent for consistent testing
  - Battle interface transformed from passive viewing to interactive strategic gameplay
  - Fixed ability parsing to correctly read database format (active1/active2 structure)
  - Corrected Aetherion Level 8 abilities to match Design Document (Mind Strike, Psy-Beam)
  - Fixed frontend caching issue preventing updated ability names from displaying
  - Added cache invalidation to ensure fresh monster data loads in battles
- June 14, 2025: Interactive Monster Card Ability System
  - Removed separate ability button grid below monster cards
  - Made ability boxes on monster cards directly clickable during player's turn
  - Added red glowing borders on affordable abilities with visual feedback
  - Implemented "Click to attack!" prompts and hover effects for interactive abilities
  - Maintained all existing damage calculations and mana cost validation
  - Abilities on opponent cards remain non-interactive for visual reference only
  - Added Basic Attack button below Mana stat with blue design (0 MP cost)
  - Basic Attack damage calculated as 0.6 × monster's Power stat
  - Always available as clickable option during player's turn
  - Fixed AI attack system to use monster's actual database abilities instead of generic attacks
  - AI Gigalith now uses Basic Attack, Magma Punch, and Tremor Stomp (removed non-existent Heavy Strike)
  - Standardized damage calculations between player and AI for consistent battle mechanics
  - Balanced AI attack distribution: Basic Attack 50%, each special ability 25%
  - Fixed database foreign key error for AI battle completion by using NULL for AI opponents
- June 14, 2025: UI Polish and Clean Design
  - Removed redundant text prompts from Basic Attack button ("Standard physical attack", "Click to attack!")
  - Cleaned up abilities section by removing all "Click to attack!" prompts
  - Maintained visual interaction cues (red glow, hover effects) for cleaner professional appearance
- June 14, 2025: AI Mana System Implementation
  - Added MP tracking to AI monsters with proper initialization (160/200 MP)
  - Implemented AI mana consumption when using abilities (Magma Punch: 30 MP, Tremor Stomp: 70 MP)
  - Fixed AI monster card to display dynamic mana values from battle state
  - Added battle log messages for AI mana consumption ("AI [X] MP consumed")
  - Fixed AI monster card mana display to show real-time mana updates during battle
  - Resolved NaN display issue with proper null coalescing for battleMp values
  - Added attack execution guard to prevent duplicate mana deduction during animations
  - Enhanced battle log debugging with before/after mana tracking for troubleshooting
  - Corrected Gigalith ability mana costs: Magma Punch (40 MP), Tremor Stomp (50 MP)
  - Synchronized database values with AI attack generation for consistent mana consumption
  - Reverted to 80% starting MP to preserve monster stats between battles for persistent resource management
- June 15, 2025: Persistent Monster Stats System
  - Added HP and MP columns to user_monsters database table for persistent stat tracking
  - Updated Monster Card display to show current HP/MP from database instead of calculated values
  - Fixed battle initialization to use persistent HP/MP values instead of recalculating from base stats
  - Implemented battle completion API endpoint to save monster stats after each fight
  - Added retreat button to battle arena allowing mid-battle exit with stat preservation
  - Updated monster purchase logic to properly initialize HP/MP for new monsters
  - Fixed getUserMonsters query to include HP/MP columns in returned data
  - Monsters now maintain HP/MP between battles for strategic resource management
- June 15, 2025: Victory Rewards System
  - Updated battle victory rewards to award exactly 10 Diamonds for wins (0 for losses)
  - Changed victory message to display "YOU WIN! You earned 10 Diamonds!"
  - Streamlined reward structure for clear player feedback
- June 15, 2025: Monster Card UI Polish and Healing System
  - Moved pulsating purple eye to left side below level indicator for owned monsters only
  - Removed blue flip button that was causing unwanted blue eye icon display
  - Added healing button below HP bar for damaged owned monsters with cost calculation
  - Implemented healing confirmation dialog showing cost and HP restoration details
  - Created backend healing API with gold balance validation and ownership checks
  - Purple pulsating eye now appears for both Gigalith (ID 6) and Aetherion (ID 7) when owned
  - Healing cost: 1 Gold per 10 HP healed (rounded up) with full HP restoration
  - Fixed Aetherion max HP from 950 to correct value of 400 HP
  - Prevented card flipping after healing confirmation with proper event handling
  - Corrected database values for accurate HP display and healing calculations
- June 15, 2025: Shattered Monster State System
  - Added `isShattered` boolean field to user_monsters database table
  - Implemented visual indicators: grayed out cards with reduced opacity
  - Added red "SHATTERED" status icon with ShieldX symbol below HP display
  - Disabled healing functionality for shattered monsters (no heal button)
  - Created battle restrictions preventing shattered monster selection
  - Auto-shattering system: monsters shatter when HP reaches 0 in battles
  - Prepared repair API endpoint for future Repair Kit item integration
  - Monster Stable now visually distinguishes between healthy and shattered monsters
- June 15, 2025: Dual Authentication System Implementation
  - Extended database schema with username, passwordHash, and authProvider fields
  - Added local username/password authentication alongside existing Replit OAuth
  - Implemented bcrypt password hashing for secure local account storage
  - Created registration and login API endpoints for local accounts
  - Added passport-local strategy for username/password authentication
  - Built beautiful tabbed interface on landing page with "Quick Start" (OAuth) and "Create Account" (local) options
  - Local accounts support username/password registration with email validation
  - Users can choose between instant OAuth login or creating custom Monster Academy accounts
  - All user data (Gold, Diamonds, Monster Stable) properly isolated by user ID regardless of auth method
- June 15, 2025: Player Inventory System Implementation
  - Added comprehensive inventory database table for non-monster items storage
  - Implemented complete CRUD operations for inventory management
  - Created beautiful backpack interface with item categorization and rarity system
  - Added backpack icon to main navigation with item count badge
  - Supports item types: consumable, tool, quest, material with rarity levels
  - Includes demo "Find Item" button to test system with Repair Kit example
  - Full integration with user authentication and data persistence
  - Ready for story quest item rewards and monster repair functionality
- June 15, 2025: Story State Manager Implementation
  - Added storyProgress column to users database table for adventure tracking
  - Implemented complete story progress API with GET/POST endpoints
  - Created comprehensive Story Manager component with choose-your-own-adventure demo
  - Added STORY tab to main navigation with 6 interconnected story nodes
  - Automatic progress saving ensures players continue exactly where they left off
  - Story nodes include Academy Gates, Great Hall, Training Grounds, Enchanted Forest
  - Full integration with user authentication and persistent database storage
  - Foundation complete for unlimited story quest expansion and narrative gameplay
- June 17, 2025: Complete Responsive Design Overhaul
  - Implemented comprehensive mobile-first responsive design across entire application
  - Updated main navigation with 2x2 grid layout for mobile, single row for tablet, full layout for desktop
  - Redesigned header with collapsible mobile layout and touch-friendly button sizing
  - Modified monster cards to use responsive CSS classes instead of fixed dimensions
  - Enhanced learning system with mobile-optimized subject selection and answer options
  - Transformed battle arena with stacked card layout for mobile devices
  - Updated monster lab with single-column layout for mobile monster management
  - Redesigned currency display with compact mobile layout and hidden labels
  - Improved inventory system with responsive dialog sizing and touch-friendly buttons
  - Added touch-manipulation classes and minimum touch target sizes (44px+) throughout
  - Implemented consistent responsive typography scaling across all components
  - All interactive elements now meet accessibility standards for mobile devices
- June 17, 2025: Starter Set Monster Expansion
  - Added five new purchasable monsters to the Monster Lab database
  - Geode Tortoise (Earth/Tank): 400 Gold - Crystalize passive doubles defense when HP < 50%
  - Gale-Feather Griffin (Air/Scout): 450 Gold - Tailwind passive boosts team speed +5%
  - Cinder-Tail Salamander (Fire/Attacker): 350 Gold - Soot Cloud passive adds poison chance
  - River-Spirit Axolotl (Water/Support): 420 Gold - Soothing Aura passive heals 3% HP per turn
  - Spark-Tail Squirrel (Electric/Controller): 380 Gold - Static Charge builds to guaranteed stun
  - All monsters include complete stat progressions, resistances, weaknesses, and level upgrades
  - Expanded monster roster from 2 to 7 total purchasable creatures for diverse gameplay strategies
- June 17, 2025: Custom Artwork Integration for Starter Monsters
  - Integrated user-provided artwork for all 5 starter monsters (levels 1-3)
  - Updated VeoApiClient with custom image generation functions for each starter monster
  - Added proper asset serving routes for attached_assets folder
  - All starter monsters now display their unique custom artwork instead of placeholders
  - Level-specific visual progression implemented for Geode Tortoise, Gale-Feather Griffin, Cinder-Tail Salamander, River-Spirit Axolotl, and Spark-Tail Squirrel
- June 17, 2025: Starter Monster Abilities Implementation
  - Fixed abilities display for all 5 starter monsters in Monster Cards
  - Updated database abilities format to match MonsterCard component expectations
  - Each starter monster now shows complete abilities with proper Active/Passive indicators
  - Added mana costs and detailed descriptions for all starter monster abilities
  - Abilities section now fully functional for Geode Tortoise, Gale-Feather Griffin, Cinder-Tail Salamander, River-Spirit Axolotl, and Spark-Tail Squirrel
- June 17, 2025: Database Starter Set Tracking
  - Added starter_set boolean field to monsters database table for categorization
  - All 5 new monsters (IDs 8-12) marked as starter_set = true in database
  - Original monsters (Gigalith, Aetherion) remain starter_set = false
  - Removed visual "STARTER SET" badges from monster cards per user request
  - Database maintains starter set classification for future functionality
- June 17, 2025: Abilities Display Order Standardization
  - Updated MonsterCard component to always display passive abilities first
  - Active abilities now appear below passive abilities in sorted order
  - Implemented automatic sorting for all current and future monster cards
  - Standard format: PASSIVE abilities (top) → ACTIVE abilities (bottom)
- June 17, 2025: Dynamic Encounter System Implementation
  - Replaced static Level 10 Gigalith opponent with comprehensive AI team generation
  - Added Team Power Level (TPL) system: monster level = power, team TPL = sum of levels
  - Implemented battle slots system: users start with 2 slots, can select up to that many monsters
  - Created AI teams database with 10 pre-designed opponents (Stone Wall, Fast Swarm, Fire Storm, etc.)
  - Added matchmaking logic: AI teams scale to match player TPL within ±10% range
  - Built BattleTeamSelector component for strategic team assembly
  - Enhanced database schema with hpPerLevel/mpPerLevel fields for level scaling
  - AI teams feature diverse archetypes: tank, swarm, aggro, support, control, balanced
  - Dynamic opponent generation ensures balanced battles regardless of team composition
  - Fixed selectedMonster runtime error by replacing legacy selection code with clean encounter system
- June 17, 2025: Monster Card Layout Fix
  - Fixed card height constraints that were cutting off weaknesses/resistance sections
  - Removed fixed 400px height from main content area and 360px from abilities section
  - Increased all card heights by 120-140px to accommodate complete content display
  - Implemented flexbox layout for natural content flow and proper section visibility
  - All monster cards now show complete information including footer weakness/resistance data
  - Removed "Click to flip" text that was overlapping with resistance information
- June 17, 2025: Complete Chapter 1 Story Implementation
  - Built comprehensive Choose Your Own Adventure story system for STORY tab
  - Implemented complete 9-node Chapter 1 narrative with branching paths
  - Added The Awakening sequence (Nodes 1-3) with mysterious Shard character and Vorvax warnings
  - Created major story branch at Forest Crossroads (Node 4) leading to two distinct paths
  - Village Path (5A-8A): Elder meeting, Hidden Den sanctuary, village defense against shadow creatures
  - Training Yard Path (5B-7B): Ancient ruins exploration, shadow confrontation, battle resolution
  - Convergence point (Node 8) revealing three ancient locations for future chapters
  - Chapter 1 cliffhanger ending (Node 9) with subscription prompt and replay functionality
  - Enhanced story node system with location images, progress saving, and visual presentation
  - Location titles, descriptions, and image placeholders for each scene
  - Special handling for chapter completion with celebration screen and restart options
- June 18, 2025: Story System Polish and Custom Artwork Integration
  - Redesigned story interface with magical scroll aesthetic featuring enchanted borders and fantasy typography
  - Added "Return to [previous node name]" navigation button for seamless story exploration
  - Integrated 8 custom story location images with ornate golden frames and mystical shimmer effects
  - Enhanced text readability with improved contrast and flexible content containers
  - Story text now dynamically expands for varying content lengths (1-7 rows) without cutoff using flexible containers
  - Maintained full responsive design compatibility across all devices
  - Updated Node 5A with corrected village entrance narrative emphasizing tension and empty atmosphere
  - Updated Node 4 choice text to use proper village name "Elderwood Village" for consistency
  - Implemented dynamic content system for Node 3 and Node 6A based on previous player choices
  - Node 3 now displays different text based on Node 2 choice (touch vs mental communication)
  - Node 6A displays different text based on Node 5A choice (approach monster vs find elder's home)
  - Enhanced narrative branching creates personalized story experiences
  - Updated Node 6A text to properly introduce Pip by name and show correct Elder interaction sequences
  - Corrected Node 7A to reflect Gloomfang Den quest with proper combat encounter setup and tactical choices
  - Updated Node 8A to Inner Chamber with Scout Commander battle and proper den progression
  - Added Node 9A reward scene for Path A completion before convergence point
  - Fixed database story progress for existing users to use correct node IDs
  - Updated Node 9A to Elder's Reward with proper location and monster reward content
  - Corrected Node 8 convergence point with proper Shard dialogue about three powerful locations
- June 18, 2025: Interest Test Implementation
  - Added subscription intent tracking with monthly/yearly preference recording
  - Created two-part Interest Test flow: subscription offer screen and email capture screen
  - Added database fields for subscriptionIntent and notificationEmail
  - Built InterestTest component with professional subscription pricing UI
  - Integrated with story system to trigger after Node_08_Great_Choice selections
  - No payment processing - purely for market research and email collection
  - Enhanced Interest Test cards with dynamic monster collage backgrounds
  - Implemented clean grid layout with 28 monster images (5 rows, no overlapping)
  - Fixed image loading by serving directly from attached_assets folder
  - Added helper function mapping exact filenames for all monster levels
  - Monster images now display properly as background elements with error handling
  - Added "Skip for Now - Return to Game" buttons on both subscription screens for easy exit
- June 19, 2025: Complete AI Battle Arena System Implementation
  - Created comprehensive AI Trainer Library with 6 unique archetypes as requested
  - Implemented battle slot purchasing system (50/150/400 diamonds for slots 3/4/5)
  - Added Rank Points (RP) system: +20 win, -10 loss, +5 bonus for defeating stronger opponents
  - Built Team Power Level (TPL) matchmaking system for balanced encounters
  - Added RankPointsDisplay component with tier progression (Rookie to Legendary Master)
  - Integrated BattleSlotUpgrade component into Monster Lab
  - Enhanced database schema with rankPoints field and AI trainer management
  - Created comprehensive API endpoints for all new Battle Arena features
  - Added AiTrainerLibrary component showing available opponents based on player TPL
- June 19, 2025: Finalized Starter Monster Cards with Complete Descriptive Text
  - Updated all 5 starter monsters with official flavor text and type lines
  - Added proper weakness/resistance data for each monster in database
  - Enhanced MonsterCard component to display database-driven descriptions
  - Geode Tortoise: Tank — Earth/Crystal, weakness Water, resistance Electric
  - Gale-Feather Griffin: Scout — Air/Flying, weakness Electric, resistance Earth
  - Cinder-Tail Salamander: Attacker — Fire, weakness Water, resistance Fire
  - River-Spirit Axolotl: Support — Water/Spirit, weakness Poison, resistance Water
  - Spark-Tail Squirrel: Controller — Electric, weakness Earth, resistance Air
  - All monster cards now display authentic lore text and proper type classifications
- June 22, 2025: Complete Abilities System Database Integration
  - Fixed "Failed to load abilities" error by implementing proper relational database structure
  - Added missing /api/monster-abilities/:monsterId endpoint for fetching monster abilities
  - Updated MonsterCard component to use correct database field names (ability_type, mp_cost, power_multiplier)
  - Connected abilities table to monsters through monster_abilities junction table
  - Verified all 7 monsters have proper abilities data (16 abilities total, 22 relationships)
  - Monster Cards now display abilities correctly with Active/Passive indicators and mana costs
  - Fixed database schema synchronization issues preventing abilities from loading
- June 24, 2025: Battle Tokens System Fix
  - Fixed "Dev: Add 5 Tokens" button functionality in Monster Lab
  - Corrected apiRequest function call format and added authentication credentials
  - Fixed Drizzle ORM property mapping issue (battle_tokens database column to battleTokens object property)
  - Cleaned up /api/dev/add-tokens endpoint with proper authentication middleware
  - Battle tokens now correctly increment when button is clicked with success notifications
- June 25, 2025: Scalability Improvements - Database-Driven Architecture
  - Removed hardcoded AI_OPPONENTS and MONSTER_NAMES constants from config files
  - Updated server routes to use database queries instead of static mappings
  - Consolidated game constants into truly static values only (battle slots, level caps)
  - Enhanced architecture to support hundreds of monsters and thousands of users
  - All monster data, abilities, and AI teams now fully database-driven for easy scaling
  - Consolidated constants into single server/gameData.ts file and removed redundant config/gameData.ts
  - Completed code review recommendations for clean, maintainable architecture
- July 1, 2025: Server-Side Battle Engine and Type Consolidation
  - Migrated damage calculation from client to server-side battleEngine.ts
  - Created /api/battle/calculate-damage endpoint with fast response times (72-84ms)
  - Updated BattleArena component to use server API for all damage calculations
  - Consolidated shared battle types (Monster, UserMonster, Ability, DamageResult) into shared/types.ts
  - Eliminated type duplication between client and server codebases
  - Server-side battle calculations maintain exact same functionality while improving security
  - Completed type consolidation: all client files now import from shared/types.ts
  - Updated 7 client components to use shared types via @shared/types import
  - Deleted redundant client/src/types/game.ts file after successful migration
  - TypeScript paths configured for @shared/* alias with successful build verification
- July 1, 2025: Server-Side Battle Session Management
  - Created in-memory battle session store using Map for active battle state management
  - Added startBattle function in battleEngine.ts with crypto.randomUUID() for unique session IDs
  - Created /api/battle/start endpoint for server-controlled battle initialization
  - Updated client handleBattleStart to request server-created battle sessions
  - Added battleId state management in BattleArena component
  - Server now generates and manages complete battle state (teams, turn order, indices)
  - Client receives authoritative battle state from server instead of creating it locally
  - Foundation established for persistent sessions, reconnection, and multiplayer features
- July 1, 2025: Server-Authoritative Turn Management
  - Enhanced applyDamage function to use battleId for session lookup instead of direct attacker/defender objects
  - Added automatic turn switching and battle end detection on server side
  - Created processAiTurn function for server-side AI decision making and action execution
  - Updated /api/battle/perform-action endpoint to accept only battleId and ability parameters
  - Added /api/battle/ai-turn endpoint for complete server-controlled AI turns
  - Modified client handlePlayerAbility to send minimal data and receive complete battle state updates
  - Simplified client handleAiAbility to make single API call with battleId only
  - Server now manages all battle logic: turn order, action validation, state updates, and win conditions
  - Client receives and applies complete authoritative battle state from every server response
  - Eliminated all client-side battle logic for fully server-controlled gameplay
- July 1, 2025: Server-Side AI Battle Logging Enhancement
  - Enhanced processAiTurn function to add specific AI ability usage messages to server battle log
  - Server now generates "Opponent's [Monster Name] used [Ability Name]!" messages with authentic data
  - Removed redundant client-side AI log message generation in handleAiAbility
  - Client now displays server's authoritative battle log instead of generating generic messages
  - Fixed bug where battle log showed "used an ability" instead of specific ability names
  - Improved battle log accuracy and consistency for better user experience
- July 2, 2025: Server-Authoritative First Turn Implementation
  - Modified startBattle function to initialize battles with turn: 'pre-battle' instead of 'player'
  - Created selectLeadAndDetermineTurn function for server-side turn order determination
  - Added /api/battle/select-lead endpoint for lead monster selection and speed comparison
  - Updated client selectLeadMonster function to use server API instead of local speed calculation
  - Server now handles all aspects of battle initialization including AI lead selection and turn order
  - Eliminated client-server state mismatch that caused "Error during AI turn" messages
  - Established proper battle lifecycle: initialize → lead selection → combat begins → server-controlled turns
- July 2, 2025: Complete Server-Authoritative Battle Logging
  - Fixed monster name access in selectLeadAndDetermineTurn using correct UserMonster.monster.name structure
  - Added comprehensive action logging to applyDamage function for both player and AI attacks
  - Removed duplicate AI action logging from processAiTurn to prevent message duplication
  - Updated client handlePlayerAbility to use server's authoritative battle log instead of generating own messages
  - Server now generates ALL battle action messages using authentic database monster names and ability names
  - Fixed "undefined enters the battle!" bug and eliminated player attack log disappearing issue
  - Completed migration: server is single source of truth for all battle logging with persistent message history
- July 2, 2025: Server-Authoritative Monster Swapping Implementation
  - Created performSwap function in battleEngine.ts with comprehensive validation (HP > 0, different monster, valid index)
  - Added /api/battle/swap endpoint with proper authentication and error handling
  - Rewrote client handleSwapMonster to use server API instead of local state manipulation
  - Fixed critical client-server state mismatch that caused "Error during AI turn" messages
  - Server now validates all swap requests and maintains authoritative battle state
  - Added authentic swap messages to battle log using real monster names from database
  - Eliminated architectural violation where client could modify battle state without server knowledge
  - Completed full server-authoritative battle system: initialization, turns, actions, logging, and swapping
- July 2, 2025: Database-Driven AI Abilities Implementation
  - Created getAbilitiesForMonsters function in storage.ts with efficient database queries
  - Modified startBattle function to collect all monster IDs and load abilities from database
  - Added abilities_map to battle state for persistent ability storage throughout battle duration
  - Completely rewrote processAiTurn function to use authentic monster abilities from database
  - Eliminated hardcoded "Basic Attack" array that violated database-driven architecture
  - AI opponents now use their actual abilities (Magma Punch, Tremor Stomp, Mind Strike, etc.)
  - Implemented intelligent AI ability selection with MP validation and basic attack fallback
  - Fixed architectural compliance: all battle data now comes from authentic database sources
  - Enhanced AI strategic behavior using real monster abilities for authentic battle encounters
- July 2, 2025: Server-Side Win/Loss Conditions Implementation
  - Fixed broken placeholder win condition logic that ended battles prematurely after single monster defeat
  - Implemented proper team-based battle ending: battles now only end when entire teams are defeated
  - Added authentic "monster has fainted!" messages to battle log using real monster names from database
  - Enhanced applyDamage function with comprehensive team status validation (every monster HP check)
  - Battles now continue properly when individual monsters are defeated but team has conscious monsters
  - Fixed core battle foundation enabling true strategic team-based gameplay with multiple monsters
  - Server maintains full authority over win/loss determination with proper multi-monster battle mechanics
- July 2, 2025: Fixed Defeat Logic and AI Automatic Monster Swapping
  - Corrected inverted team checking logic that caused "Cannot read properties of undefined" errors
  - Fixed monster name access by properly identifying which team was attacked after turn switching
  - Implemented server-authoritative AI automatic monster swapping when active AI monster is defeated
  - AI now automatically sends out next healthy monster when current one faints but team isn't eliminated
  - Added authentic "Opponent sends out [Monster Name]!" messages to battle log using database names
  - Enhanced battle realism with proper AI behavior matching expected monster game mechanics
  - Eliminated critical server errors during player attacks that defeat AI opponents
- July 2, 2025: Player Forced Swap Implementation
  - Added 'player-must-swap' turn state to shared Turn type definition for consistent client-server communication
  - Implemented server-enforced mandatory player swapping when player's active monster is defeated
  - Server now puts battle into 'player-must-swap' state when player monster faints but team isn't eliminated
  - Added prominent red UI indicator with clear instructions: "Your monster has fainted! Choose a new monster from your bench to continue."
  - Modified performSwap function to handle forced swap state transitions back to AI turn
  - Player ability buttons automatically disabled during forced swap state (only bench clicking allowed)
  - Completed symmetric battle flow: both AI and player forced swaps now handled server-authoritatively
  - Enhanced battle system foundation with proper mandatory swap mechanics for strategic team-based gameplay
- July 2, 2025: Fixed Forced Swap UI Logic (Task 8i)
  - Decoupled ability usage logic from swapping logic by adding separate canSwap prop to CombatView
  - Added canSwap boolean to CombatViewProps interface and component destructuring
  - Updated BenchCard disabled logic to use canSwap instead of isPlayerTurn for swap buttons
  - Swap buttons now enabled during both 'player' and 'player-must-swap' turn states
  - Ability buttons remain correctly disabled during forced swap state
  - Fixed critical bug where players couldn't continue battles after monster defeat
  - Completed clean architectural separation of UI concerns for proper battle flow
- July 2, 2025: Fixed Swap Function Execution (Task 8j)
  - Modified handleSwapMonster guard clause to allow execution during 'player-must-swap' state
  - Changed condition from `turn !== 'player'` to `(turn !== 'player' && turn !== 'player-must-swap')`
  - Completed final missing piece for fully functional forced swap system
  - Players can now successfully click swap buttons during forced swap state
  - Server-authoritative forced swap workflow now complete from detection to execution
  - Battle flow seamlessly handles mandatory monster swapping with proper UI feedback
- July 2, 2025: Server-Side MP Validation Implementation (Task 8k)
  - Added MP validation at the beginning of applyDamage function before any action execution
  - Server now validates attacker's current MP against ability cost before allowing actions
  - Throws "Not enough MP" error if insufficient resources, preventing client-side cheating
  - Uses authentic battleMp or mp values from server battle state for validation
  - Enforces server authority over resource management in battle system
  - Prevents malicious clients from bypassing MP limitations through manipulation
  - Completes server-authoritative battle architecture with proper resource validation
- July 2, 2025: Current Monster Stats at Battle Start (Task 8L)
  - Fixed handleBattleStart function to send current monster HP/MP instead of resetting to maximum
  - Removed playerTeamWithFullHealth logic that incorrectly reset hp: m.maxHp, mp: m.maxMp
  - Server now receives authentic monster stats from database, preserving persistent resource management
  - Enables testing of low-resource scenarios and server-side MP validation logic
  - Eliminated architectural violation where client modified monster state before server submission
  - Battles now start with monsters' actual current HP/MP for strategic resource management
- July 2, 2025: Server-Authoritative Battle Completion (Task 9b)
  - Added concludeBattle function to storage.ts that awards XP using existing awardRankXp logic
  - Modified applyDamage function to be async and automatically call concludeBattle when player wins
  - Server now immediately awards 50 XP when battle ends with player victory, no client involvement
  - Updated battle routes to properly await async applyDamage and processAiTurn functions
  - Eliminated final gap in server-authoritative architecture - server handles entire battle lifecycle
  - Battle completion, XP awarding, and result logging now fully server-controlled and atomic
  - Removes client responsibility for battle completion API calls, preventing manipulation
- July 2, 2025: Final Battle Cleanup - Remove Redundant Logic (Task 9c)
  - Removed handleBattleCompletion function from client that was causing double XP awards
  - Deleted all handleBattleCompletion function calls in handlePlayerAbility and handleAiAbility
  - Removed obsolete POST /api/battle/complete server endpoint that was no longer needed
  - Eliminated dead code and redundant client-server battle completion round trips
  - Completed server-authoritative migration with clean, single-responsibility architecture
  - XP now awarded exactly once by server when battle ends, preventing double rewards
  - Final client-server separation: server handles logic, client handles display only
- July 2, 2025: Critical Deep Copy Fix for Battle State (Task 9f)
  - Fixed data corruption bug in startBattle function that was resetting monster HP to full
  - Replaced shallow copy ([...playerTeam]) with proper deep copy using JSON.parse(JSON.stringify())
  - Battle sessions now create completely isolated monster objects preventing data corruption
  - Original monster roster data remains untouched during battles, preserving authentic HP/MP values
  - Enables proper implementation of persistent monster stats after battle completion
  - Eliminated root cause of HP reset bug while maintaining correct MP behavior
- July 2, 2025: Persistent Battle State Saving (Task 9g - Redo with Transactions)
  - Created saveFinalBattleState function using database transactions with Promise.all() for atomic operations
  - Integrated persistent state saving into applyDamage function during battle completion
  - All player monsters' final HP/MP values automatically saved to database when battles end
  - Implements persistent resource loss system - monsters retain damage between battles
  - Database transactions ensure ACID compliance and prevent partial updates
  - Completes server-authoritative persistent monster stats architecture with reliable data integrity
- July 2, 2025: Client Cache Invalidation (Task 9i)
  - Added useEffect hook in BattleArena.tsx to invalidate client cache when battles end
  - Uses queryClient.invalidateQueries({ queryKey: ['/api/user/monsters'] }) to force fresh data retrieval
  - Eliminates stale data issue where Monster Stable showed outdated HP/MP values after battles
  - Ensures users immediately see authentic post-battle monster damage in their roster
  - Completes persistent battle state system with proper client-server data synchronization
- July 2, 2025: Strict 3-Phase Turn Lifecycle Implementation (Phase 1 Foundation)
  - Refactored server/battleEngine.ts with explicit 3-phase turn structure: Start-of-Turn, Action Phase, End-of-Turn
  - Created handleStartOfTurn() function for status effects, DoT application, and turn-skipping logic
  - Created handleActionPhase() function encapsulating ability execution with existing damage calculations
  - Created handleEndOfTurn() function for passive triggers, duration countdown, and turn switching
  - Extracted executeAbility() and handleMonsterDefeatLogic() helper functions for clean separation
  - Updated applyDamage() and processAiTurn() to use strict phase ordering with non-negotiable sequence
  - Established foundation for advanced mechanics: PARALYZED, BURNED, POISONED, and passive abilities
  - All phases maintain server authority with database-driven values and authentic monster data
  - Framework ready for unlimited status effects, bench passives, and complex turn-based interactions
- July 2, 2025: Complete Database Field Access Enhancement (Task 11)
  - Enhanced getAbilitiesForMonsters function to select all 18+ ability fields from database
  - Added critical fields: activation_trigger, activation_scope, status_effect_*, healing_power, stat_modifiers
  - Battle engine now receives complete ability specifications from database for all future implementations
  - Eliminated data starvation that forced hardcoding in battle mechanics
  - Foundation established for database-driven healing, status effects, passive abilities, and stat modifications
  - System architecture now fully supports unlimited ability types through complete database access
- July 2, 2025: Healing Ability Processing System Implementation (Task 12)
  - Created executeHealingAbility function that uses database healing_power field for healing calculations
  - Refactored handleActionPhase to route abilities based on healing_power > 0 condition
  - Healing abilities now bypass damage calculation pipeline and process correctly
  - Restoring Geyser and other healing abilities now function using authentic database values
  - Added proper MP cost deduction and battle log messages for healing abilities
  - Separated healing logic from damage logic for improved maintainability and accuracy
- July 2, 2025: Dynamic Targeting System Implementation (Task 13)
  - Updated /api/battle/perform-action endpoint to accept optional targetId parameter from client
  - Modified applyDamage function signature to accept targetId for server-side target resolution
  - Enhanced handleActionPhase with dynamic target finding logic using monster IDs
  - Removed hardcoded "const target = attacker" targeting limitation
  - Server now searches battleState.playerTeam and battleState.aiTeam arrays for specified targets
  - Established foundation for database-driven target_scope validation in future implementations
  - Maintains server authority over all targeting decisions while accepting client suggestions
- July 3, 2025: Complete Server-Authoritative Battle Log Implementation (Task 14)
  - Enhanced executeAbility function to generate detailed combat result messages
  - Added server-side logging for critical hits with "A critical hit!" message
  - Added server-side logging for type effectiveness with "It's super effective!" and "It's not very effective..." messages
  - Server now generates ALL combat event messages using authentic damageResult calculations
  - Eliminated need for client-side combat logic by making battleState.battleLog the complete authoritative record
  - Critical hits use authentic 5% chance calculation with 1.5x damage multiplier from server
  - Type effectiveness uses authentic database-driven affinity calculations with 2.0x/0.5x multipliers
  - Completed server-authoritative architecture with zero client-side combat message generation required
- July 3, 2025: Client-Side Battle Log Cleanup Implementation (Task 15)
  - Removed all client-side log message generation from BattleArena.tsx component
  - Eliminated additionalLog arrays and client-side critical hit/effectiveness message creation
  - Updated handlePlayerAbility and handleAiAbility to use only server's authoritative battleLog
  - Removed unused getEffectivenessMessage function that was generating duplicate messages
  - Client now displays 100% server-controlled battle log without any local message generation
  - Fixed architectural violation where client was undermining server authority over combat messaging
  - Eliminated duplicate log message issue by making server the single source of truth for all battle events
- July 3, 2025: END_OF_TURN Passive Abilities Implementation (Task 16)
  - Implemented complete passive ability system in handleEndOfTurn function using database-driven logic
  - Added support for activation_trigger, activation_scope, status_effect_chance validation from database
  - Implemented chance-based passive activation using Math.random() against database status_effect_chance values
  - Added healing passive effects using database healing_power field with proper HP restoration
  - Supports SELF, BENCH, and ALL_ALLIES activation scopes for strategic passive targeting
  - Server generates authentic battle log messages for passive ability activations
  - All logic remains server-authoritative with zero client involvement in passive mechanics
  - Foundation established for unlimited passive ability types through complete database-driven architecture
- July 3, 2025: AI Move Selection Bug Fix (Task 17)
  - Fixed critical bug where AI was attempting to use PASSIVE abilities as actions
  - Added ability_type === 'ACTIVE' filter in processAiTurn function before move selection
  - AI now only considers ACTIVE abilities when choosing its next move
  - Updated basic attack fallback logic to use filtered activeAbilities array instead of full ability list
  - Prevented invalid AI actions that violated core game rules about ability types
  - All filtering uses database-driven ability_type field with server-authoritative validation
- July 3, 2025: Passive Healing Database Field Fix (Task 18)
  - Fixed passive healing detection by using correct database field status_effect_applies === 'HEALING'
  - Replaced incorrect healing_power field with proper status_effect_value and status_effect_value_type
  - Implemented proper targeting logic based on activation_scope: BENCH targets active monster, ACTIVE/SELF targets ability owner
  - Added support for PERCENT_MAX_HP and FLAT healing value types from database
  - Fixed Soothing Aura (bench passive) to correctly heal active monster instead of self
  - Enhanced battle log to show correct monster names for passive activations and healing targets
  - All healing calculations now use authentic database fields with server-authoritative validation
- July 3, 2025: Server-Client Health Property Synchronization Fix (Task 19)
  - Added battleHp and battleMaxHp properties to all monsters in startBattle function initialization
  - Standardized all server battle engine functions to use consistent battleHp/battleMaxHp properties
  - Updated executeAbility, executeHealingAbility, and handleEndOfTurn to use unified health properties
  - Modified MonsterCard component to prioritize battleHp/battleMaxHp over base hp/maxHp values
  - Fixed HP bar display inconsistency where client showed outdated values during battles
  - Resolved Soothing Aura intermittent behavior by ensuring reliable maxHp lookup from battleMaxHp
  - Eliminated data inconsistency between server battle state and client display properties
  - Client now renders authoritative health state provided by server with proper fallback chain
- July 3, 2025: Battle State Persistence Fix (Task 20)
  - Fixed saveFinalBattleState function in storage.ts to save authoritative battle health to database
  - Changed .set() call to use battleHp and battleMp instead of outdated hp/mp properties
  - Monster damage from battles now persists correctly instead of reverting to pre-battle values
  - Resolved data integrity issue where player progress was lost after battle completion
  - Server's authoritative battle state (battleHp/battleMp) now correctly saved to database hp/mp columns
  - Eliminates frustrating bug where monsters appeared to heal automatically after battles
  - Maintains proper persistent resource management for strategic gameplay experience
- July 3, 2025: Opponent Health Display Fix (Task 21)
  - Fixed MonsterCard component to display opponent's authoritative battle health from server
  - Added monsterProp.battleHp and monsterProp.battleMaxHp to health display fallback chain
  - Opponent HP bars now update correctly when taking damage during battles
  - Eliminated client-server health display inconsistency for AI opponents
  - Client now displays 100% server-authoritative battle health for all monsters (player and opponent)
  - Completed final data synchronization between server calculations and client display
- July 3, 2025: START_OF_TURN Passive Abilities Implementation (Task 22)
  - Implemented comprehensive START_OF_TURN passive ability logic in handleStartOfTurn function
  - Added database-driven passive ability processing using activation_trigger, activation_scope, and ability_type
  - Supports all activation scopes: ACTIVE, BENCH, SELF, and ALL_ALLIES with proper targeting logic
  - Implemented chance-based activation using status_effect_chance field from database
  - Added healing passive effects with PERCENT_MAX_HP and FLAT value types support
  - Enhanced battle log with descriptive START_OF_TURN passive activation messages
  - Completed 3-phase turn lifecycle: Start-of-Turn → Action Phase → End-of-Turn
  - All logic remains server-authoritative with zero client involvement in passive mechanics

## User Preferences

Preferred communication style: Simple, everyday language.