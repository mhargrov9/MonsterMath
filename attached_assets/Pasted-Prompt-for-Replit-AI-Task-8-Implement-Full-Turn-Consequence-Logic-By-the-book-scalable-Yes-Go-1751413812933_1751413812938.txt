Prompt for Replit AI: Task 8 - Implement Full Turn Consequence Logic
By the book, scalable: Yes.

Goal: Fix the identified bugs by making the server fully authoritative over the consequences of a battle action. This includes managing fainted monsters, swapping to benched monsters, and correctly updating the battle log.

Instructions:

Enhance processAiTurn in server/battleEngine.ts:

Find the processAiTurn function.

After an ability is chosen but before applyDamage is called, add a line to the battleState.battleLog. The message should be: Opponent's ${attacker.name} used ${ability.name}!. This will fix the missing log message.

Enhance applyDamage in server/battleEngine.ts:

This function needs to become much smarter. After calculating the new HP and MP, it must manage the consequences.

Check for Fainted Defender: Add an if statement to check if the defender's newHp is less than or equal to 0.

Inside the if block:

Add a message to the battleState.battleLog: ${defender.name} has been defeated!.

Determine which team the defender belonged to (player or AI).

Check if there are any other monsters on that team's bench with HP greater than 0.

If there are available monsters: Find the index of the next available monster and update the appropriate active index (activePlayerIndex or activeAiIndex) in the battleState. Do not end the battle.

If there are no available monsters: The battle is over. Set battleState.battleEnded to true and set battleState.winner to the opposing team ('player' or 'ai').

Return the Full State:

Ensure that both the processAiTurn and applyDamage functions always return the complete, updated battleState object after all logic has been processed. The client relies on this to render correctly.

Verification Steps (To be confirmed by the Developer):

The "Error during AI turn!" message should be gone.

The battle log should now correctly state which ability the AI used.

When an opponent's active monster is defeated, the server should automatically swap to the next available monster on their bench. The battle should only end when all monsters on a team are defeated.